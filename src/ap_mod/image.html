<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <title>Assistant</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">
        <link href="../css/style.css" rel="stylesheet">
    </head>
    <body>
        <div class="container" id="app">
            <button type="button" class="btn btn-primary" onclick="add_pic()" title="pic_title"><loc>add</loc></button>
            <input type="file" class="form-control form-control-sm hidden" title="file_upload" id="file"></div>
            <ol class="list-group list-group-sm list-group-numbered" id="lg">
                <input type="hidden" id="count" value="0">
            </ol>
        </div>
        <script src="../js/app.js"></script>
        <script src="../js/lang.js"></script>
        <script src="../js/ocr_general.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            window.onload = function() {
                let firstRun = detect_first_run();
                if (firstRun) {
                    var link = document.createElement('a');
                    link.href = "first_run.html";
                    link.click();
                }
                let cfg = JSON.parse(fc(config_path()));
                update(cfg.language);
            }
            let path = localStorage.getItem("project_path");
            let json_mfs = JSON.parse(fc(path+"/project.json"));
            function count() {
                let count = document.getElementById("count").value;
                return count;
            }
            function cpp() {
                let count = document.getElementById("count").value;
                count++;
                document.getElementById("count").value = count;
                return count;
            }
            function cmm() {
                let count = document.getElementById("count").value;
                count--;
                document.getElementById("count").value = count;
                return count;
            }
            function add_pic() {
                // load a file selection popup
                let file = document.getElementById("file");
                file.click();
                // get the file path
                file.onchange = function() {
                    // check that the file is an image
                    let file_path = file.value;
                    let file_type = file_path.split(".").pop();
                    if (file_type == "png" || file_type == "jpg" || file_type == "jpeg") {
                        // get the file name
                        let file_name = file_path.split("\\").pop();
                        // get the file ocr result
                        let file_ocr = ocr(file_path);
                        // add result to lg
                        let lg = document.getElementById("lg");
                        let li = document.createElement("li");
                        li.id = "li_"+count();
                        li.className = "list-group-item d-flex justify-content-between align-items-start";
                        let div = document.createElement("div");
                        div.className = "ms-2 me-auto";
                        let div_fw = document.createElement("div");
                        div_fw.className = "fw-bold";
                        div_fw.id = "fn_"+count();
                        div_fw.innerHTML = file_name;
                        let span = document.createElement("span");
                        span.id = "result_"+count();
                        span.innerHTML = file_ocr;
                        div.appendChild(div_fw);
                        div.appendChild(span);
                        li.appendChild(div);
                        let up_btn = document.createElement("button");
                        up_btn.className = "btn btn-gray trans";
                        let up = document.createElement("i");
                        up.className = "bi bi-caret-up-fill dblue";
                        up.id = "up_"+count();
                        up_btn.appendChild(up);
                        var cnt = count();
                        up_btn.onclick = function() {
                            up_func(cnt);
                        }
                        li.appendChild(up_btn);
                        let down_btn = document.createElement("button");
                        down_btn.className = "btn btn-gray trans";
                        let down = document.createElement("i");
                        down.className = "bi bi-caret-down-fill dblue";
                        down.id = "down_"+count();
                        down_btn.appendChild(down);
                        down_btn.onclick = function() {
                            down_func(cnt);
                        }
                        li.appendChild(down_btn);
                        let trash_btn = document.createElement("button");
                        trash_btn.className = "btn btn-gray trans";
                        let trash = document.createElement("i");
                        trash.className = "bi bi-trash3-fill red";
                        trash.id = "trash_"+count();
                        trash_btn.appendChild(trash);
                        trash_btn.onclick = function() {
                            trash_func(cnt);
                        }
                        li.appendChild(trash_btn);
                        lg.appendChild(li);
                        cpp();
                    }
                }
            }
            function up_func(id) {
                if (id == 1) {
                    return false;
                }
                // swap li_id and li_{id-1}
                let li_id = document.getElementById("li_"+id);
                let li_id_prev = document.getElementById("li_"+(id-1));
                for (let i = 0; i < li_id.childNodes.length; i++) {
                    if (li_id.childNodes[i].id == "up_"+id) {
                        li_id.childNodes[i].id = "up_"+(id-1);
                    }
                    if (li_id.childNodes[i].id == "down_"+id) {
                        li_id.childNodes[i].id = "down_"+(id-1);
                    }
                    if (li_id.childNodes[i].id == "trash_"+id) {
                        li_id.childNodes[i].id = "trash_"+(id-1);
                    }
                    if (li_id.childNodes[i].id == "fn_"+id) {
                        li_id.childNodes[i].id = "fn_"+(id-1);
                    }
                    if (li_id.childNodes[i].id == "result_"+id) {
                        li_id.childNodes[i].id = "result_"+(id-1);
                    }
                }
                for (let i = 0; i < li_id_prev.childNodes.length; i++) {
                    if (li_id_prev.childNodes[i].id == "up_"+(id-1)) {
                        li_id_prev.childNodes[i].id = "up_"+id;
                    }
                    if (li_id_prev.childNodes[i].id == "down_"+(id-1)) {
                        li_id_prev.childNodes[i].id = "down_"+id;
                    }
                    if (li_id_prev.childNodes[i].id == "trash_"+(id-1)) {
                        li_id_prev.childNodes[i].id = "trash_"+id;
                    }
                    if (li_id_prev.childNodes[i].id == "fn_"+(id-1)) {
                        li_id_prev.childNodes[i].id = "fn_"+id;
                    }
                    if (li_id_prev.childNodes[i].id == "result_"+(id-1)) {
                        li_id_prev.childNodes[i].id = "result_"+id;
                    }
                }
                let tmp = document.getElementById("fn_"+id).innerHTML;
                document.getElementById("fn_"+id).innerHTML = document.getElementById("fn_"+(id-1)).innerHTML;
                document.getElementById("fn_"+(id-1)).innerHTML = tmp;
                tmp = document.getElementById("result_"+id).innerHTML;
                document.getElementById("result_"+id).innerHTML = document.getElementById("result_"+(id-1)).innerHTML;
                document.getElementById("result_"+(id-1)).innerHTML = tmp;
                li_id.id = "li_"+(id-1);
                li_id_prev.id = "li_"+id;
                return true;
            }
            function down_func(id) {
                if (id == count()) {
                    return false;
                }
                // swap li_id and li_{id+1}
                let li_id = document.getElementById("li_"+id);
                let li_id_next = document.getElementById("li_"+(id+1));
                for (let i = 0; i < li_id.childNodes.length; i++) {
                    if (li_id.childNodes[i].id == "up_"+id) {
                        li_id.childNodes[i].id = "up_"+(id+1);
                    }
                    if (li_id.childNodes[i].id == "down_"+id) {
                        li_id.childNodes[i].id = "down_"+(id+1);
                    }
                    if (li_id.childNodes[i].id == "trash_"+id) {
                        li_id.childNodes[i].id = "trash_"+(id+1);
                    }
                    if (li_id.childNodes[i].id == "fn_"+id) {
                        li_id.childNodes[i].id = "fn_"+(id+1);
                    }
                    if (li_id.childNodes[i].id == "result_"+id) {
                        li_id.childNodes[i].id = "result_"+(id+1);
                    }
                }
                for (let i = 0; i < li_id_next.childNodes.length; i++) {
                    if (li_id_next.childNodes[i].id == "up_"+(id+1)) {
                        li_id_next.childNodes[i].id = "up_"+id;
                    }
                    if (li_id_next.childNodes[i].id == "down_"+(id+1)) {
                        li_id_next.childNodes[i].id = "down_"+id;
                    }
                    if (li_id_next.childNodes[i].id == "trash_"+(id+1)) {
                        li_id_next.childNodes[i].id = "trash_"+id;
                    }
                    if (li_id_next.childNodes[i].id == "fn_"+(id+1)) {
                        li_id_next.childNodes[i].id = "fn_"+id;
                    }
                    if (li_id_next.childNodes[i].id == "result_"+(id+1)) {
                        li_id_next.childNodes[i].id = "result_"+id;
                    }
                }
                let tmp = document.getElementById("fn_"+id).innerHTML;
                document.getElementById("fn_"+id).innerHTML = document.getElementById("fn_"+(id+1)).innerHTML;
                document.getElementById("fn_"+(id+1)).innerHTML = tmp;
                tmp = document.getElementById("result_"+id).innerHTML;
                document.getElementById("result_"+id).innerHTML = document.getElementById("result_"+(id+1)).innerHTML;
                document.getElementById("result_"+(id+1)).innerHTML = tmp;
                li_id.id = "li_"+(id+1);
                li_id_next.id = "li_"+id;
                return true;
            }
            function trash_func(id) {
                for (let i = id; i < count(); i++) {
                    down_func(i);
                }
                document.getElementById("li_"+count()).remove();
                cmm();
                return true;
            }
        </script>
    </body>
</html>